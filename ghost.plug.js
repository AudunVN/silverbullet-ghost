var mod=(()=>{var v=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var Q=Object.prototype.hasOwnProperty;var m=(e,r)=>{for(var t in r)v(e,t,{get:r[t],enumerable:!0})},W=(e,r,t,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of z(r))!Q.call(e,o)&&o!==t&&v(e,o,{get:()=>r[o],enumerable:!(n=V(r,o))||n.enumerable});return e};var Z=e=>W(v({},"__esModule",{value:!0}),e);var Be={};m(Be,{functionMapping:()=>Y});function R(e){let r=atob(e),t=r.length,n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=r.charCodeAt(o);return n}function X(e,r){return syscall("sandboxFetch.fetch",e,r)}function U(){globalThis.fetch=async function(e,r){let t=await X(e,r&&{method:r.method,headers:r.headers,body:r.body});return new Response(t.base64Body?R(t.base64Body):null,{status:t.status,headers:t.headers})}}typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var S=new Map,A=0;function P(e){self.postMessage(e)}self.syscall=async(e,...r)=>await new Promise((t,n)=>{A++,S.set(A,{resolve:t,reject:n}),P({type:"sys",id:A,name:e,args:r})});function $(e,r){self.addEventListener("message",t=>{(async()=>{let n=t.data;switch(n.type){case"inv":{let o=e[n.name];if(!o)throw new Error(`Function not loaded: ${n.name}`);try{let i=await Promise.resolve(o(...n.args||[]));P({type:"invr",id:n.id,result:i})}catch(i){console.error(i),P({type:"invr",id:n.id,error:i.message})}}break;case"sysr":{let o=n.id,i=S.get(o);if(!i)throw Error("Invalid request id");S.delete(o),n.error?i.reject(new Error(n.error)):i.resolve(n.result)}break}})().catch(console.error)}),P({type:"manifest",manifest:r})}U();function k(e,r){if(r(e))return[e];let t=[];if(e.children)for(let n of e.children)t=[...t,...k(n,r)];return t}function C(e,r){if(e.children){let t=e.children.slice();for(let n of t){let o=r(n);if(o!==void 0){let i=e.children.indexOf(n);o?e.children.splice(i,1,o):e.children.splice(i,1)}else C(n,r)}}}function p(e,r){return k(e,t=>t.type===r)[0]}function D(e,r){k(e,r)}function E(e){let r=[];if(e.text!==void 0)return e.text;for(let t of e.children)r.push(E(t));return r.join("")}typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var s=self.syscall;var d={};m(d,{parseMarkdown:()=>re});function re(e){return s("markdown.parseMarkdown",e)}var u={};m(u,{deleteAttachment:()=>de,deletePage:()=>se,getAttachmentMeta:()=>ue,getPageMeta:()=>ne,listAttachments:()=>ce,listPages:()=>te,listPlugs:()=>ae,readAttachment:()=>le,readPage:()=>oe,writeAttachment:()=>fe,writePage:()=>ie});function te(e=!1){return s("space.listPages",e)}function ne(e){return s("space.getPageMeta",e)}function oe(e){return s("space.readPage",e)}function ie(e,r){return s("space.writePage",e,r)}function se(e){return s("space.deletePage",e)}function ae(){return s("space.listPlugs")}function ce(){return s("space.listAttachments")}function ue(e){return s("space.getAttachmentMeta",e)}function le(e){return s("space.readAttachment",e)}function fe(e,r){return s("space.writeAttachment",e,r)}function de(e){return s("space.deleteAttachment",e)}var l=self.syscall;var g={};m(g,{parse:()=>be,stringify:()=>Te});function be(e){return l("yaml.parse",e)}function Te(e){return l("yaml.stringify",e)}async function ve(e,r){let t=await u.readPage(e),n=await d.parseMarkdown(t),o;return D(n,i=>{if(i.type!=="FencedCode")return!1;let c=p(i,"CodeInfo");if(r&&!c||r&&!r.includes(c.children[0].text))return!1;let y=p(i,"CodeText");return y?(o=y.children[0].text,!0):!1}),o}async function x(e,r=["yaml"]){let t=await ve(e,r);if(t!==void 0)try{return g.parse(t)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}var Ae="SETTINGS";async function H(e,r){try{let n=(await x(Ae,["yaml"])||{})[e];return n===void 0?r:n}catch(t){if(t.message==="Not found")return r;throw t}}async function j(e){try{let t=(await x("SECRETS",["yaml","secrets"]))[e];if(t===void 0)throw new Error(`No such secret: ${e}`);return t}catch(r){throw r.message==="Not found"?new Error(`No such secret: ${e}`):r}}function Se(e){return e.replaceAll(" ","_")}async function I(e,r){let t=await d.parseMarkdown(e);return C(t,n=>{if(n.type==="WikiLink"){let o=n.children[1].children[0].text;return r&&!r.includes(o)?{text:`_${o}_`}:{text:`[${o}](/${Se(o)})`}}if(n.type==="CommentBlock"||n.type==="Comment"||n.type==="NamedAnchor")return null;if(n.type==="Hashtag")return{text:`__${n.children[0].text}__`};if(n.type==="URL"){let o=n.children[0].text;o.indexOf("://")===-1&&(n.children[0].text=`fs/${o}`),console.log("Link",o)}if(n.type==="FencedCode"){let o=p(n,"CodeInfo");if(!o)return;if(o.children[0].text==="meta")return null}}),E(t)}var f={};m(f,{decode:()=>Re,encode:()=>Ne});var a=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"];function _(e){let r=typeof e=="string"?new TextEncoder().encode(e):e instanceof Uint8Array?e:new Uint8Array(e),t="",n,o=r.length;for(n=2;n<o;n+=3)t+=a[r[n-2]>>2],t+=a[(r[n-2]&3)<<4|r[n-1]>>4],t+=a[(r[n-1]&15)<<2|r[n]>>6],t+=a[r[n]&63];return n===o+1&&(t+=a[r[n-2]>>2],t+=a[(r[n-2]&3)<<4],t+="=="),n===o&&(t+=a[r[n-2]>>2],t+=a[(r[n-2]&3)<<4|r[n-1]>>4],t+=a[(r[n-1]&15)<<2],t+="="),t}function F(e){let r=atob(e),t=r.length,n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=r.charCodeAt(o);return n}function Ce(e){if(e.length%4===2)return e+"==";if(e.length%4===3)return e+"=";if(e.length%4===1)throw new TypeError("Illegal base64url string!");return e}function Ee(e){if(!/^[-_A-Z0-9]*?={0,2}$/i.test(e))throw new TypeError("Failed to decode base64url: invalid character");return Ce(e).replace(/\-/g,"+").replace(/_/g,"/")}function Me(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function Ne(e){return Me(_(e))}function Re(e){return F(Ee(e))}var h=new TextEncoder,Ue=new TextDecoder;function K(e){return e!==null}function B(e){return e===null}function w(e){return typeof e=="string"}function $e(e){return w(e.hash?.name)}function De(e){return w(e.namedCurve)}function L(e,r){if(e==="none"){if(K(r))throw new Error(`The alg '${e}' does not allow a key.`);return!0}else{if(!r)throw new Error(`The alg '${e}' demands a key.`);let t=r.algorithm,n=M(e);if(t.name===n.name){if($e(t))return t.hash.name===n.hash.name;if(De(t))return t.namedCurve===n.namedCurve}return!1}}function M(e){switch(e){case"HS256":return{hash:{name:"SHA-256"},name:"HMAC"};case"HS384":return{hash:{name:"SHA-384"},name:"HMAC"};case"HS512":return{hash:{name:"SHA-512"},name:"HMAC"};case"PS256":return{hash:{name:"SHA-256"},name:"RSA-PSS",saltLength:32};case"PS384":return{hash:{name:"SHA-384"},name:"RSA-PSS",saltLength:48};case"PS512":return{hash:{name:"SHA-512"},name:"RSA-PSS",saltLength:64};case"RS256":return{hash:{name:"SHA-256"},name:"RSASSA-PKCS1-v1_5"};case"RS384":return{hash:{name:"SHA-384"},name:"RSASSA-PKCS1-v1_5"};case"RS512":return{hash:{name:"SHA-512"},name:"RSASSA-PKCS1-v1_5"};case"ES256":return{hash:{name:"SHA-256"},name:"ECDSA",namedCurve:"P-256"};case"ES384":return{hash:{name:"SHA-384"},name:"ECDSA",namedCurve:"P-384"};default:throw new Error(`The jwt's alg '${e}' is not supported.`)}}async function q(e,r,t){return B(r)?"":f.encode(new Uint8Array(await crypto.subtle.sign(M(e),r,h.encode(t))))}function Oe(e,r){return`${f.encode(h.encode(JSON.stringify(e)))}.${f.encode(h.encode(JSON.stringify(r)))}`}async function G(e,r,t){if(L(e.alg,t)){let n=Oe(e,r),o=await q(e.alg,t,n);return`${n}.${o}`}else throw new Error(`The jwt's alg '${e.alg}' does not match the key's algorithm.`)}function N(e){return Math.round((e instanceof Date?e.getTime():Date.now()+e*1e3)/1e3)}var He=e=>Uint8Array.from(e.match(/.{1,2}/g).map(r=>parseInt(r,16))),b=class{constructor(r,t){this.url=r;this.key=t}async init(){let[r,t]=this.key.split(":"),n=await crypto.subtle.importKey("raw",He(t),{name:"HMAC",hash:"SHA-256"},!0,["sign","verify"]);this.token=await G({alg:"HS256",kid:r,typ:"JWT"},{exp:N(5*60),iat:N(0),aud:"/v3/admin/"},n)}async listPosts(){return(await(await fetch(`${this.url}/ghost/api/v3/admin/posts?order=published_at+DESC`,{headers:{Authorization:`Ghost ${this.token}`}})).json()).posts}async listMarkdownPosts(){let r=[];for(let t of await this.listPosts()){let n=JSON.parse(t.mobiledoc);n.cards.length>0&&n.cards[0][0]==="markdown"&&r.push(t)}return r}publishPost(r){return this.publish("posts",r)}publishPage(r){return this.publish("pages",r)}async publish(r,t){let o=await(await fetch(`${this.url}/ghost/api/v3/admin/${r}/slug/${t.slug}`,{headers:{Authorization:`Ghost ${this.token}`,"Content-Type":"application/json"}})).json();if(o[r]){let i=o[r][0];return t.updated_at=i.updated_at,(await(await fetch(`${this.url}/ghost/api/v3/admin/${r}/${i.id}`,{method:"PUT",headers:{Authorization:`Ghost ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({[r]:[t]})})).json())[r][0]}else return t.status||(t.status="draft"),(await(await fetch(`${this.url}/ghost/api/v3/admin/${r}`,{method:"POST",headers:{Authorization:`Ghost ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({[r]:[t]})})).json())[r][0]}};function je(e){return JSON.stringify({version:"0.3.1",atoms:[],cards:[["markdown",{markdown:e}]],markups:[],sections:[[10,0],[1,"p",[]]]})}var Ie=/#\s*([^\n]+)\n(([^\n]|\n)+)$/;async function _e(e){let r=Ie.exec(e);if(r){let[,t,n]=r;return{title:t,mobiledoc:je(await I(n))}}throw Error("Post should stat with a # header")}async function Fe(){let e=await H("ghost"),r=await j("ghost");for(let[t,n]of Object.entries(e))n.adminKey=r[t];return e}async function J(e){let r=await Fe(),[,t,n,o]=e.uri.split(":"),i=r[t];if(!i)throw new Error("No config for instance "+t);let c=new b(i.url,i.adminKey);await c.init();let y=await u.readPage(e.name),T=await _e(y);return T.slug=o,n==="post"?await c.publishPost(T):n==="page"&&await c.publishPage(T),!0}var Y={publish:J},Ke={name:"ghost",requiredPermissions:["fetch"],functions:{publish:{path:"./ghost.ts:publish",env:"server",events:["share:ghost"]}},assets:{}};$(Y,Ke);return Z(Be);})();
