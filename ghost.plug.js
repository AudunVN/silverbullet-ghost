var mod=(()=>{var S=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var m=(e,t)=>{for(var n in t)S(e,n,{get:t[n],enumerable:!0})},V=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Y(t))!z.call(e,o)&&o!==n&&S(e,o,{get:()=>t[o],enumerable:!(r=J(t,o))||r.enumerable});return e};var W=e=>V(S({},"__esModule",{value:!0}),e);var Ve={};m(Ve,{functionMapping:()=>Q});typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var v=new Map,A=0;function P(e){self.postMessage(e)}self.syscall=async(e,...t)=>await new Promise((n,r)=>{A++,v.set(A,{resolve:n,reject:r}),P({type:"sys",id:A,name:e,args:t})});function R(e,t){self.addEventListener("message",n=>{(async()=>{let r=n.data;switch(r.type){case"inv":{let o=e[r.name];if(!o)throw new Error(`Function not loaded: ${r.name}`);try{let s=await Promise.resolve(o(...r.args||[]));P({type:"invr",id:r.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",r.name,"error:",s),P({type:"invr",id:r.id,error:s.message})}}break;case"sysr":{let o=r.id,s=v.get(o);if(!s)throw Error("Invalid request id");v.delete(o),r.error?s.reject(new Error(r.error)):s.resolve(r.result)}break}})().catch(console.error)}),P({type:"manifest",manifest:t})}function Z(e){let t=atob(e),n=t.length,r=new Uint8Array(n);for(let o=0;o<n;o++)r[o]=t.charCodeAt(o);return r}function U(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",n=e.byteLength;for(let r=0;r<n;r++)t+=String.fromCharCode(e[r]);return btoa(t)}async function X(e,t){if(typeof e!="string"){let n=new Uint8Array(await e.arrayBuffer()),r=n.length>0?U(n):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:r},e=e.url}return syscall("sandboxFetch.fetch",e,t)}function ee(){globalThis.nativeFetch=globalThis.fetch,globalThis.fetch=async function(e,t){let n=t&&t.body?U(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,r=await X(e,t&&{method:t.method,headers:t.headers,base64Body:n});return new Response(r.base64Body?Z(r.base64Body):null,{status:r.status,headers:r.headers})}}ee();function C(e,t){if(t(e))return[e];let n=[];if(e.children)for(let r of e.children)n=[...n,...C(r,t)];return n}function k(e,t){if(e.children){let n=e.children.slice();for(let r of n){let o=t(r);if(o!==void 0){let s=e.children.indexOf(r);o?e.children.splice(s,1,o):e.children.splice(s,1)}else k(r,t)}}}function p(e,t){return C(e,n=>n.type===t)[0]}function $(e,t){C(e,t)}function E(e){let t=[];if(e.text!==void 0)return e.text;for(let n of e.children)t.push(E(n));return t.join("")}typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var i=self.syscall;var f={};m(f,{parseMarkdown:()=>te});function te(e){return i("markdown.parseMarkdown",e)}var l={};m(l,{deleteAttachment:()=>fe,deleteFile:()=>ye,deletePage:()=>se,getAttachmentMeta:()=>ue,getFileMeta:()=>ge,getPageMeta:()=>ne,listAttachments:()=>ce,listFiles:()=>me,listPages:()=>re,listPlugs:()=>ae,readAttachment:()=>le,readFile:()=>pe,readPage:()=>oe,writeAttachment:()=>de,writeFile:()=>he,writePage:()=>ie});function re(e=!1){return i("space.listPages",e)}function ne(e){return i("space.getPageMeta",e)}function oe(e){return i("space.readPage",e)}function ie(e,t){return i("space.writePage",e,t)}function se(e){return i("space.deletePage",e)}function ae(){return i("space.listPlugs")}function ce(){return i("space.listAttachments")}function ue(e){return i("space.getAttachmentMeta",e)}function le(e){return i("space.readAttachment",e)}function de(e,t){return i("space.writeAttachment",e,t)}function fe(e){return i("space.deleteAttachment",e)}function me(){return i("space.listFiles")}function pe(e){return i("space.readFile",e)}function ge(e){return i("space.getFileMeta",e)}function he(e,t){return i("space.writeFile",e,t)}function ye(e){return i("space.deleteFile",e)}var c=globalThis.syscall;var g={};m(g,{parse:()=>ke,stringify:()=>Ee});function ke(e){return c("yaml.parse",e)}function Ee(e){return c("yaml.stringify",e)}async function Re(e,t){let n=await l.readPage(e),r=await f.parseMarkdown(n),o;return $(r,s=>{if(s.type!=="FencedCode")return!1;let u=p(s,"CodeInfo");if(t&&!u||t&&!t.includes(u.children[0].text))return!1;let y=p(s,"CodeText");return y?(o=y.children[0].text,!0):!1}),o}async function x(e,t=["yaml"]){let n=await Re(e,t);if(n!==void 0)try{return g.parse(n)}catch(r){throw console.error("YAML Page parser error",r),new Error(`YAML Error: ${r.message}`)}}var Ue="SETTINGS";async function O(e,t){try{let r=(await x(Ue,["yaml"])||{})[e];return r===void 0?t:r}catch(n){if(n.message==="Not found")return t;throw n}}async function D(e){try{let n=(await x("SECRETS",["yaml","secrets"]))[e];if(n===void 0)throw new Error(`No such secret: ${e}`);return n}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e}`):t}}function $e(e){return e.replaceAll(" ","_")}async function F(e,t){let n=await f.parseMarkdown(e);return k(n,r=>{if(r.type==="WikiLink"){let o=r.children[1].children[0].text;return t&&!t.includes(o)?{text:`_${o}_`}:{text:`[${o}](/${$e(o)})`}}if(r.type==="CommentBlock"||r.type==="Comment"||r.type==="NamedAnchor")return null;if(r.type==="Hashtag")return{text:`__${r.children[0].text}__`};if(r.type==="URL"){let o=r.children[0].text;o.indexOf("://")===-1&&(r.children[0].text=`fs/${o}`),console.log("Link",o)}if(r.type==="FencedCode"){let o=p(r,"CodeInfo");if(!o)return;if(o.children[0].text==="meta")return null}}),E(n)}var d={};m(d,{decode:()=>je,encode:()=>He});var a=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"];function H(e){let t=typeof e=="string"?new TextEncoder().encode(e):e instanceof Uint8Array?e:new Uint8Array(e),n="",r,o=t.length;for(r=2;r<o;r+=3)n+=a[t[r-2]>>2],n+=a[(t[r-2]&3)<<4|t[r-1]>>4],n+=a[(t[r-1]&15)<<2|t[r]>>6],n+=a[t[r]&63];return r===o+1&&(n+=a[t[r-2]>>2],n+=a[(t[r-2]&3)<<4],n+="=="),r===o&&(n+=a[t[r-2]>>2],n+=a[(t[r-2]&3)<<4|t[r-1]>>4],n+=a[(t[r-1]&15)<<2],n+="="),n}function j(e){let t=atob(e),n=t.length,r=new Uint8Array(n);for(let o=0;o<n;o++)r[o]=t.charCodeAt(o);return r}function Oe(e){if(e.length%4===2)return e+"==";if(e.length%4===3)return e+"=";if(e.length%4===1)throw new TypeError("Illegal base64url string!");return e}function De(e){if(!/^[-_A-Z0-9]*?={0,2}$/i.test(e))throw new TypeError("Failed to decode base64url: invalid character");return Oe(e).replace(/\-/g,"+").replace(/_/g,"/")}function Fe(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function He(e){return Fe(H(e))}function je(e){return j(De(e))}var h=new TextEncoder,_e=new TextDecoder;function _(e){return e!==null}function B(e){return e===null}function w(e){return typeof e=="string"}function Be(e){return w(e.hash?.name)}function Le(e){return w(e.namedCurve)}function L(e,t){if(e==="none"){if(_(t))throw new Error(`The alg '${e}' does not allow a key.`);return!0}else{if(!t)throw new Error(`The alg '${e}' demands a key.`);let n=t.algorithm,r=M(e);if(n.name===r.name){if(Be(n))return n.hash.name===r.hash.name;if(Le(n))return n.namedCurve===r.namedCurve}return!1}}function M(e){switch(e){case"HS256":return{hash:{name:"SHA-256"},name:"HMAC"};case"HS384":return{hash:{name:"SHA-384"},name:"HMAC"};case"HS512":return{hash:{name:"SHA-512"},name:"HMAC"};case"PS256":return{hash:{name:"SHA-256"},name:"RSA-PSS",saltLength:32};case"PS384":return{hash:{name:"SHA-384"},name:"RSA-PSS",saltLength:48};case"PS512":return{hash:{name:"SHA-512"},name:"RSA-PSS",saltLength:64};case"RS256":return{hash:{name:"SHA-256"},name:"RSASSA-PKCS1-v1_5"};case"RS384":return{hash:{name:"SHA-384"},name:"RSASSA-PKCS1-v1_5"};case"RS512":return{hash:{name:"SHA-512"},name:"RSASSA-PKCS1-v1_5"};case"ES256":return{hash:{name:"SHA-256"},name:"ECDSA",namedCurve:"P-256"};case"ES384":return{hash:{name:"SHA-384"},name:"ECDSA",namedCurve:"P-384"};default:throw new Error(`The jwt's alg '${e}' is not supported.`)}}async function I(e,t,n){return B(t)?"":d.encode(new Uint8Array(await crypto.subtle.sign(M(e),t,h.encode(n))))}function Ie(e,t){return`${d.encode(h.encode(JSON.stringify(e)))}.${d.encode(h.encode(JSON.stringify(t)))}`}async function q(e,t,n){if(L(e.alg,n)){let r=Ie(e,t),o=await I(e.alg,n,r);return`${r}.${o}`}else throw new Error(`The jwt's alg '${e.alg}' does not match the key's algorithm.`)}function N(e){return Math.round((e instanceof Date?e.getTime():Date.now()+e*1e3)/1e3)}var qe=e=>Uint8Array.from(e.match(/.{1,2}/g).map(t=>parseInt(t,16))),b=class{constructor(t,n){this.url=t;this.key=n}token;async init(){let[t,n]=this.key.split(":"),r=await crypto.subtle.importKey("raw",qe(n),{name:"HMAC",hash:"SHA-256"},!0,["sign","verify"]);this.token=await q({alg:"HS256",kid:t,typ:"JWT"},{exp:N(5*60),iat:N(0),aud:"/v3/admin/"},r)}async listPosts(){return(await(await fetch(`${this.url}/ghost/api/v3/admin/posts?order=published_at+DESC`,{headers:{Authorization:`Ghost ${this.token}`}})).json()).posts}async listMarkdownPosts(){let t=[];for(let n of await this.listPosts()){let r=JSON.parse(n.mobiledoc);r.cards.length>0&&r.cards[0][0]==="markdown"&&t.push(n)}return t}publishPost(t){return this.publish("posts",t)}publishPage(t){return this.publish("pages",t)}async publish(t,n){let o=await(await fetch(`${this.url}/ghost/api/v3/admin/${t}/slug/${n.slug}`,{headers:{Authorization:`Ghost ${this.token}`,"Content-Type":"application/json"}})).json();if(o[t]){let s=o[t][0];return n.updated_at=s.updated_at,(await(await fetch(`${this.url}/ghost/api/v3/admin/${t}/${s.id}`,{method:"PUT",headers:{Authorization:`Ghost ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({[t]:[n]})})).json())[t][0]}else return n.status||(n.status="draft"),(await(await fetch(`${this.url}/ghost/api/v3/admin/${t}`,{method:"POST",headers:{Authorization:`Ghost ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({[t]:[n]})})).json())[t][0]}};function Ge(e){return JSON.stringify({version:"0.3.1",atoms:[],cards:[["markdown",{markdown:e}]],markups:[],sections:[[10,0],[1,"p",[]]]})}var Qe=/#\s*([^\n]+)\n(([^\n]|\n)+)$/;async function Je(e){let t=Qe.exec(e);if(t){let[,n,r]=t;return{title:n,mobiledoc:Ge(await F(r))}}throw Error("Post should stat with a # header")}async function Ye(){let e=await O("ghost"),t=await D("ghost");for(let[n,r]of Object.entries(e))r.adminKey=t[n];return e}async function G(e){let t=await Ye(),[,n,r,o]=e.uri.split(":"),s=t[n];if(!s)throw new Error("No config for instance "+n);let u=new b(s.url,s.adminKey);await u.init();let y=await l.readPage(e.name),T=await Je(y);return T.slug=o,r==="post"?await u.publishPost(T):r==="page"&&await u.publishPage(T),!0}var Q={publish:G},ze={name:"ghost",requiredPermissions:["fetch"],functions:{publish:{path:"./ghost.ts:publish",events:["share:ghost"]}},assets:{}};R(Q,ze);return W(Ve);})();
