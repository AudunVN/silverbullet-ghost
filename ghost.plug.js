var mod=(()=>{var v=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var y=(r,e)=>{for(var t in e)v(r,t,{get:e[t],enumerable:!0})},Z=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Q(e))!W.call(r,o)&&o!==t&&v(r,o,{get:()=>e[o],enumerable:!(n=z(e,o))||n.enumerable});return r};var X=r=>Z(v({},"__esModule",{value:!0}),r);var $e={};y($e,{functionMapping:()=>V});function $(r){let e=atob(r),t=e.length,n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=e.charCodeAt(o);return n}function ee(r,e){return syscall("sandboxFetch.fetch",r,e)}function R(){globalThis.fetch=async function(r,e){let t=await ee(r,e&&{method:e.method,headers:e.headers,body:e.body});return new Response(t.base64Body?$(t.base64Body):null,{status:t.status,headers:t.headers})}}typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var A=new Map,S=0;function P(r){self.postMessage(r)}self.syscall=async(r,...e)=>await new Promise((t,n)=>{S++,A.set(S,{resolve:t,reject:n}),P({type:"sys",id:S,name:r,args:e})});function D(r,e){self.addEventListener("message",t=>{(async()=>{let n=t.data;switch(n.type){case"inv":{let o=r[n.name];if(!o)throw new Error(`Function not loaded: ${n.name}`);try{let s=await Promise.resolve(o(...n.args||[]));P({type:"invr",id:n.id,result:s})}catch(s){console.error(s),P({type:"invr",id:n.id,error:s.message})}}break;case"sysr":{let o=n.id,s=A.get(o);if(!s)throw Error("Invalid request id");A.delete(o),n.error?s.reject(new Error(n.error)):s.resolve(n.result)}break}})().catch(console.error)}),P({type:"manifest",manifest:e})}R();function k(r,e){if(e(r))return[r];let t=[];if(r.children)for(let n of r.children)t=[...t,...k(n,e)];return t}function C(r,e){if(r.children){let t=r.children.slice();for(let n of t){let o=e(n);if(o!==void 0){let s=r.children.indexOf(n);o?r.children.splice(s,1,o):r.children.splice(s,1)}else C(n,e)}}}function m(r,e){return k(r,t=>t.type===e)[0]}function O(r,e){k(r,e)}function E(r){let e=[];if(r.text!==void 0)return r.text;for(let t of r.children)e.push(E(t));return e.join("")}typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var i=self.syscall;var f={};y(f,{parseMarkdown:()=>ne});function ne(r){return i("markdown.parseMarkdown",r)}var M=class{listPages(e=!1){return i("space.listPages",e)}getPageMeta(e){return i("space.getPageMeta",e)}readPage(e){return i("space.readPage",e)}writePage(e,t){return i("space.writePage",e,t)}deletePage(e){return i("space.deletePage",e)}listPlugs(){return i("space.listPlugs")}listAttachments(){return i("space.listAttachments")}getAttachmentMeta(e){return i("space.getAttachmentMeta",e)}readAttachment(e){return i("space.readAttachment",e)}writeAttachment(e,t,n){return i("space.writeAttachment",e,t,n)}deleteAttachment(e){return i("space.deleteAttachment",e)}readFile(e,t){return i("space.readFile",e,t)}getFileMeta(e){return i("space.getFileMeta",e)}writeFile(e,t,n){return i("space.writeFile",e,t,n)}deleteFile(e){return i("space.deleteFile",e)}listFiles(e){return i("space.listFiles",e)}},d=new M;var a=self.syscall;var g={};y(g,{parse:()=>fe,stringify:()=>de});function fe(r){return a("yaml.parse",r)}function de(r){return a("yaml.stringify",r)}async function me(r,e){let t=await d.readPage(r),n=await f.parseMarkdown(t),o;return O(n,s=>{if(s.type!=="FencedCode")return!1;let c=m(s,"CodeInfo");if(e&&!c||e&&!e.includes(c.children[0].text))return!1;let h=m(s,"CodeText");return h?(o=h.children[0].text,!0):!1}),o}async function x(r,e=["yaml"]){let t=await me(r,e);if(t!==void 0)try{return g.parse(t)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}var ge="SETTINGS";async function H(r,e){try{let n=(await x(ge,["yaml"])||{})[r];return n===void 0?e:n}catch(t){if(t.message==="Not found")return e;throw t}}async function j(r){try{let t=(await x("SECRETS",["yaml","secrets"]))[r];if(t===void 0)throw new Error(`No such secret: ${r}`);return t}catch(e){throw e.message==="Not found"?new Error(`No such secret: ${r}`):e}}function pe(r){return r.replaceAll(" ","_")}async function _(r,e){let t=await f.parseMarkdown(r);return C(t,n=>{if(n.type==="WikiLink"){let o=n.children[1].children[0].text;return e&&!e.includes(o)?{text:`_${o}_`}:{text:`[${o}](/${pe(o)})`}}if(n.type==="CommentBlock"||n.type==="Comment"||n.type==="NamedAnchor")return null;if(n.type==="Hashtag")return{text:`__${n.children[0].text}__`};if(n.type==="URL"){let o=n.children[0].text;o.indexOf("://")===-1&&(n.children[0].text=`fs/${o}`),console.log("Link",o)}if(n.type==="FencedCode"){let o=m(n,"CodeInfo");if(!o)return;if(o.children[0].text==="meta")return null}}),E(t)}var u={};y(u,{decode:()=>be,encode:()=>we});var l=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"];function I(r){let e=typeof r=="string"?new TextEncoder().encode(r):r instanceof Uint8Array?r:new Uint8Array(r),t="",n,o=e.length;for(n=2;n<o;n+=3)t+=l[e[n-2]>>2],t+=l[(e[n-2]&3)<<4|e[n-1]>>4],t+=l[(e[n-1]&15)<<2|e[n]>>6],t+=l[e[n]&63];return n===o+1&&(t+=l[e[n-2]>>2],t+=l[(e[n-2]&3)<<4],t+="=="),n===o&&(t+=l[e[n-2]>>2],t+=l[(e[n-2]&3)<<4|e[n-1]>>4],t+=l[(e[n-1]&15)<<2],t+="="),t}function K(r){let e=atob(r),t=e.length,n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=e.charCodeAt(o);return n}function ye(r){if(r.length%4===2)return r+"==";if(r.length%4===3)return r+"=";if(r.length%4===1)throw new TypeError("Illegal base64url string!");return r}function Pe(r){if(!/^[-_A-Z0-9]*?={0,2}$/i.test(r))throw new TypeError("Failed to decode base64url: invalid character");return ye(r).replace(/\-/g,"+").replace(/_/g,"/")}function xe(r){return r.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function we(r){return xe(I(r))}function be(r){return K(Pe(r))}var p=new TextEncoder,Te=new TextDecoder;function B(r){return r!==null}function L(r){return r===null}function w(r){return typeof r=="string"}function ve(r){return w(r.hash?.name)}function Se(r){return w(r.namedCurve)}function q(r,e){if(r==="none"){if(B(e))throw new Error(`The alg '${r}' does not allow a key.`);return!0}else{if(!e)throw new Error(`The alg '${r}' demands a key.`);let t=e.algorithm,n=F(r);if(t.name===n.name){if(ve(t))return t.hash.name===n.hash.name;if(Se(t))return t.namedCurve===n.namedCurve}return!1}}function F(r){switch(r){case"HS256":return{hash:{name:"SHA-256"},name:"HMAC"};case"HS384":return{hash:{name:"SHA-384"},name:"HMAC"};case"HS512":return{hash:{name:"SHA-512"},name:"HMAC"};case"PS256":return{hash:{name:"SHA-256"},name:"RSA-PSS",saltLength:32};case"PS384":return{hash:{name:"SHA-384"},name:"RSA-PSS",saltLength:48};case"PS512":return{hash:{name:"SHA-512"},name:"RSA-PSS",saltLength:64};case"RS256":return{hash:{name:"SHA-256"},name:"RSASSA-PKCS1-v1_5"};case"RS384":return{hash:{name:"SHA-384"},name:"RSASSA-PKCS1-v1_5"};case"RS512":return{hash:{name:"SHA-512"},name:"RSASSA-PKCS1-v1_5"};case"ES256":return{hash:{name:"SHA-256"},name:"ECDSA",namedCurve:"P-256"};case"ES384":return{hash:{name:"SHA-384"},name:"ECDSA",namedCurve:"P-384"};default:throw new Error(`The jwt's alg '${r}' is not supported.`)}}async function G(r,e,t){return L(e)?"":u.encode(new Uint8Array(await crypto.subtle.sign(F(r),e,p.encode(t))))}function Ae(r,e){return`${u.encode(p.encode(JSON.stringify(r)))}.${u.encode(p.encode(JSON.stringify(e)))}`}async function J(r,e,t){if(q(r.alg,t)){let n=Ae(r,e),o=await G(r.alg,t,n);return`${n}.${o}`}else throw new Error(`The jwt's alg '${r.alg}' does not match the key's algorithm.`)}function N(r){return Math.round((r instanceof Date?r.getTime():Date.now()+r*1e3)/1e3)}var ke=r=>Uint8Array.from(r.match(/.{1,2}/g).map(e=>parseInt(e,16))),b=class{constructor(e,t){this.url=e;this.key=t}async init(){let[e,t]=this.key.split(":"),n=await crypto.subtle.importKey("raw",ke(t),{name:"HMAC",hash:"SHA-256"},!0,["sign","verify"]);this.token=await J({alg:"HS256",kid:e,typ:"JWT"},{exp:N(5*60),iat:N(0),aud:"/v3/admin/"},n)}async listPosts(){return(await(await fetch(`${this.url}/ghost/api/v3/admin/posts?order=published_at+DESC`,{headers:{Authorization:`Ghost ${this.token}`}})).json()).posts}async listMarkdownPosts(){let e=[];for(let t of await this.listPosts()){let n=JSON.parse(t.mobiledoc);n.cards.length>0&&n.cards[0][0]==="markdown"&&e.push(t)}return e}publishPost(e){return this.publish("posts",e)}publishPage(e){return this.publish("pages",e)}async publish(e,t){let o=await(await fetch(`${this.url}/ghost/api/v3/admin/${e}/slug/${t.slug}`,{headers:{Authorization:`Ghost ${this.token}`,"Content-Type":"application/json"}})).json();if(o[e]){let s=o[e][0];return t.updated_at=s.updated_at,(await(await fetch(`${this.url}/ghost/api/v3/admin/${e}/${s.id}`,{method:"PUT",headers:{Authorization:`Ghost ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({[e]:[t]})})).json())[e][0]}else return t.status||(t.status="draft"),(await(await fetch(`${this.url}/ghost/api/v3/admin/${e}`,{method:"POST",headers:{Authorization:`Ghost ${this.token}`,"Content-Type":"application/json"},body:JSON.stringify({[e]:[t]})})).json())[e][0]}};function Ce(r){return JSON.stringify({version:"0.3.1",atoms:[],cards:[["markdown",{markdown:r}]],markups:[],sections:[[10,0],[1,"p",[]]]})}var Ee=/#\s*([^\n]+)\n(([^\n]|\n)+)$/;async function Me(r){let e=Ee.exec(r);if(e){let[,t,n]=e;return{title:t,mobiledoc:Ce(await _(n))}}throw Error("Post should stat with a # header")}async function Fe(){let r=await H("ghost"),e=await j("ghost");for(let[t,n]of Object.entries(r))n.adminKey=e[t];return r}async function Y(r){let e=await Fe(),[,t,n,o]=r.uri.split(":"),s=e[t];if(!s)throw new Error("No config for instance "+t);let c=new b(s.url,s.adminKey);await c.init();let h=await d.readPage(r.name),T=await Me(h);return T.slug=o,n==="post"?await c.publishPost(T):n==="page"&&await c.publishPage(T),!0}var V={publish:Y},Ne={name:"ghost",imports:["https://get.silverbullet.md/global.plug.json"],functions:{publish:{path:"./ghost.ts:publish",env:"server",events:["share:ghost"]}},assets:{}};D(V,Ne);return X($e);})();
