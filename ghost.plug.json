{
  "name": "ghost",
  "imports": [
    "https://get.silverbullet.md/global.plug.json"
  ],
  "functions": {
    "publish": {
      "env": "server",
      "events": [
        "share:ghost"
      ],
      "code": "(() => { var mod=(()=>{var Y=Object.create;var h=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,Q=Object.prototype.hasOwnProperty;var N=(r=>typeof require!=\"undefined\"?require:typeof Proxy!=\"undefined\"?new Proxy(r,{get:(e,t)=>(typeof require!=\"undefined\"?require:e)[t]}):r)(function(r){if(typeof require!=\"undefined\")return require.apply(this,arguments);throw new Error('Dynamic require of \"'+r+'\" is not supported')});var w=(r,e)=>{for(var t in e)h(r,t,{get:e[t],enumerable:!0})},M=(r,e,t,n)=>{if(e&&typeof e==\"object\"||typeof e==\"function\")for(let o of z(e))!Q.call(r,o)&&o!==t&&h(r,o,{get:()=>e[o],enumerable:!(n=J(e,o))||n.enumerable});return r};var $=(r,e,t)=>(t=r!=null?Y(q(r)):{},M(e||!r||!r.__esModule?h(t,\"default\",{value:r,enumerable:!0}):t,r)),V=r=>M(h({},\"__esModule\",{value:!0}),r);var be={};w(be,{default:()=>Te});function S(r,e){if(e(r))return[r];let t=[];if(r.children)for(let n of r.children)t=[...t,...S(n,e)];return t}function T(r,e){if(r.children){let t=r.children.slice();for(let n of t){let o=e(n);if(o!==void 0){let s=r.children.indexOf(n);o?r.children.splice(s,1,o):r.children.splice(s,1)}else T(n,e)}}}function m(r,e){return S(r,t=>t.type===e)[0]}function R(r,e){S(r,e)}function b(r){let e=[];if(r.text!==void 0)return r.text;for(let t of r.children)e.push(b(t));return e.join(\"\")}typeof self>\"u\"&&(self={syscall:()=>{throw new Error(\"Not implemented here\")}});var i=self.syscall;var l={};w(l,{parseMarkdown:()=>X});function X(r){return i(\"markdown.parseMarkdown\",r)}var A=class{listPages(e=!1){return i(\"space.listPages\",e)}getPageMeta(e){return i(\"space.getPageMeta\",e)}readPage(e){return i(\"space.readPage\",e)}writePage(e,t){return i(\"space.writePage\",e,t)}deletePage(e){return i(\"space.deletePage\",e)}listPlugs(){return i(\"space.listPlugs\")}listAttachments(){return i(\"space.listAttachments\")}getAttachmentMeta(e){return i(\"space.getAttachmentMeta\",e)}readAttachment(e){return i(\"space.readAttachment\",e)}writeAttachment(e,t,n){return i(\"space.writeAttachment\",e,t,n)}deleteAttachment(e){return i(\"space.deleteAttachment\",e)}readFile(e,t){return i(\"space.readFile\",e,t)}getFileMeta(e){return i(\"space.getFileMeta\",e)}writeFile(e,t,n){return i(\"space.writeFile\",e,t,n)}deleteFile(e){return i(\"space.deleteFile\",e)}listFiles(e){return i(\"space.listFiles\",e)}},d=new A;var v=$(N(\"https://deno.land/std/encoding/yaml.ts\"));async function y(r,e=[\"yaml\"]){let t=await d.readPage(r),n=await l.parseMarkdown(t),o={};return R(n,s=>{if(s.type!==\"FencedCode\")return!1;let c=m(s,\"CodeInfo\");if(!c||!e.includes(c.children[0].text))return!1;let p=m(s,\"CodeText\");if(!p)return!1;let f=p.children[0].text;try{o=v.parse(f)}catch(E){throw console.error(\"YAML Page parser error\",E),new Error(`YAML Error: ${E.message}`)}return!0}),o}var oe=$(N(\"https://deno.land/std/encoding/yaml.ts\"));var ie=\"SETTINGS\";async function H(r,e){try{let n=(await y(ie,[\"yaml\"])||{})[r];return n===void 0?e:n}catch(t){if(t.message===\"Page not found\")return e;throw t}}async function j(r){try{let t=(await y(\"SECRETS\",[\"yaml\",\"secrets\"]))[r];if(t===void 0)throw new Error(`No such secret: ${r}`);return t}catch(e){throw e.message===\"Page not found\"?new Error(`No such secret: ${r}`):e}}function se(r){return r.replaceAll(\" \",\"_\")}async function F(r,e){let t=await l.parseMarkdown(r);return T(t,n=>{if(n.type===\"WikiLink\"){let o=n.children[1].children[0].text;return e&&!e.includes(o)?{text:`_${o}_`}:{text:`[${o}](/${se(o)})`}}if(n.type===\"CommentBlock\"||n.type===\"Comment\"||n.type===\"NamedAnchor\")return null;if(n.type===\"Hashtag\")return{text:`__${n.children[0].text}__`};if(n.type===\"URL\"){let o=n.children[0].text;o.indexOf(\"://\")===-1&&(n.children[0].text=`fs/${o}`),console.log(\"Link\",o)}if(n.type===\"FencedCode\"){let o=m(n,\"CodeInfo\");if(!o)return;if(o.children[0].text===\"meta\")return null}}),b(t)}var u={};w(u,{decode:()=>fe,encode:()=>de});var a=[\"A\",\"B\",\"C\",\"D\",\"E\",\"F\",\"G\",\"H\",\"I\",\"J\",\"K\",\"L\",\"M\",\"N\",\"O\",\"P\",\"Q\",\"R\",\"S\",\"T\",\"U\",\"V\",\"W\",\"X\",\"Y\",\"Z\",\"a\",\"b\",\"c\",\"d\",\"e\",\"f\",\"g\",\"h\",\"i\",\"j\",\"k\",\"l\",\"m\",\"n\",\"o\",\"p\",\"q\",\"r\",\"s\",\"t\",\"u\",\"v\",\"w\",\"x\",\"y\",\"z\",\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"+\",\"/\"];function U(r){let e=typeof r==\"string\"?new TextEncoder().encode(r):r instanceof Uint8Array?r:new Uint8Array(r),t=\"\",n,o=e.length;for(n=2;n<o;n+=3)t+=a[e[n-2]>>2],t+=a[(e[n-2]&3)<<4|e[n-1]>>4],t+=a[(e[n-1]&15)<<2|e[n]>>6],t+=a[e[n]&63];return n===o+1&&(t+=a[e[n-2]>>2],t+=a[(e[n-2]&3)<<4],t+=\"==\"),n===o&&(t+=a[e[n-2]>>2],t+=a[(e[n-2]&3)<<4|e[n-1]>>4],t+=a[(e[n-1]&15)<<2],t+=\"=\"),t}function _(r){let e=atob(r),t=e.length,n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=e.charCodeAt(o);return n}function ce(r){if(r.length%4===2)return r+\"==\";if(r.length%4===3)return r+\"=\";if(r.length%4===1)throw new TypeError(\"Illegal base64url string!\");return r}function ue(r){if(!/^[-_A-Z0-9]*?={0,2}$/i.test(r))throw new TypeError(\"Failed to decode base64url: invalid character\");return ce(r).replace(/\\-/g,\"+\").replace(/_/g,\"/\")}function le(r){return r.replace(/=/g,\"\").replace(/\\+/g,\"-\").replace(/\\//g,\"_\")}function de(r){return le(U(r))}function fe(r){return _(ue(r))}var g=new TextEncoder,me=new TextDecoder;function D(r){return r!==null}function I(r){return r===null}function P(r){return typeof r==\"string\"}function ge(r){return P(r.hash?.name)}function pe(r){return P(r.namedCurve)}function K(r,e){if(r===\"none\"){if(D(e))throw new Error(`The alg '${r}' does not allow a key.`);return!0}else{if(!e)throw new Error(`The alg '${r}' demands a key.`);let t=e.algorithm,n=k(r);if(t.name===n.name){if(ge(t))return t.hash.name===n.hash.name;if(pe(t))return t.namedCurve===n.namedCurve}return!1}}function k(r){switch(r){case\"HS256\":return{hash:{name:\"SHA-256\"},name:\"HMAC\"};case\"HS384\":return{hash:{name:\"SHA-384\"},name:\"HMAC\"};case\"HS512\":return{hash:{name:\"SHA-512\"},name:\"HMAC\"};case\"PS256\":return{hash:{name:\"SHA-256\"},name:\"RSA-PSS\",saltLength:32};case\"PS384\":return{hash:{name:\"SHA-384\"},name:\"RSA-PSS\",saltLength:48};case\"PS512\":return{hash:{name:\"SHA-512\"},name:\"RSA-PSS\",saltLength:64};case\"RS256\":return{hash:{name:\"SHA-256\"},name:\"RSASSA-PKCS1-v1_5\"};case\"RS384\":return{hash:{name:\"SHA-384\"},name:\"RSASSA-PKCS1-v1_5\"};case\"RS512\":return{hash:{name:\"SHA-512\"},name:\"RSASSA-PKCS1-v1_5\"};case\"ES256\":return{hash:{name:\"SHA-256\"},name:\"ECDSA\",namedCurve:\"P-256\"};case\"ES384\":return{hash:{name:\"SHA-384\"},name:\"ECDSA\",namedCurve:\"P-384\"};default:throw new Error(`The jwt's alg '${r}' is not supported.`)}}async function L(r,e,t){return I(e)?\"\":u.encode(new Uint8Array(await crypto.subtle.sign(k(r),e,g.encode(t))))}function he(r,e){return`${u.encode(g.encode(JSON.stringify(r)))}.${u.encode(g.encode(JSON.stringify(e)))}`}async function B(r,e,t){if(K(r.alg,t)){let n=he(r,e),o=await L(r.alg,t,n);return`${n}.${o}`}else throw new Error(`The jwt's alg '${r.alg}' does not match the key's algorithm.`)}function C(r){return Math.round((r instanceof Date?r.getTime():Date.now()+r*1e3)/1e3)}var ye=r=>Uint8Array.from(r.match(/.{1,2}/g).map(e=>parseInt(e,16))),x=class{constructor(e,t){this.url=e;this.key=t}async init(){let[e,t]=this.key.split(\":\"),n=await crypto.subtle.importKey(\"raw\",ye(t),{name:\"HMAC\",hash:\"SHA-256\"},!0,[\"sign\",\"verify\"]);this.token=await B({alg:\"HS256\",kid:e,typ:\"JWT\"},{exp:C(5*60),iat:C(0),aud:\"/v3/admin/\"},n)}async listPosts(){return(await(await fetch(`${this.url}/ghost/api/v3/admin/posts?order=published_at+DESC`,{headers:{Authorization:`Ghost ${this.token}`}})).json()).posts}async listMarkdownPosts(){let e=[];for(let t of await this.listPosts()){let n=JSON.parse(t.mobiledoc);n.cards.length>0&&n.cards[0][0]===\"markdown\"&&e.push(t)}return e}publishPost(e){return this.publish(\"posts\",e)}publishPage(e){return this.publish(\"pages\",e)}async publish(e,t){let o=await(await fetch(`${this.url}/ghost/api/v3/admin/${e}/slug/${t.slug}`,{headers:{Authorization:`Ghost ${this.token}`,\"Content-Type\":\"application/json\"}})).json();if(o[e]){let s=o[e][0];return t.updated_at=s.updated_at,(await(await fetch(`${this.url}/ghost/api/v3/admin/${e}/${s.id}`,{method:\"PUT\",headers:{Authorization:`Ghost ${this.token}`,\"Content-Type\":\"application/json\"},body:JSON.stringify({[e]:[t]})})).json())[e][0]}else return t.status||(t.status=\"draft\"),(await(await fetch(`${this.url}/ghost/api/v3/admin/${e}`,{method:\"POST\",headers:{Authorization:`Ghost ${this.token}`,\"Content-Type\":\"application/json\"},body:JSON.stringify({[e]:[t]})})).json())[e][0]}};function Pe(r){return JSON.stringify({version:\"0.3.1\",atoms:[],cards:[[\"markdown\",{markdown:r}]],markups:[],sections:[[10,0],[1,\"p\",[]]]})}var xe=/#\\s*([^\\n]+)\\n([^$]+)$/;async function we(r){let e=xe.exec(r);if(e){let[,t,n]=e;return{title:t,mobiledoc:Pe(await F(n))}}throw Error(\"Post should stat with a # header\")}async function Se(){let r=await H(\"ghost\"),e=await j(\"ghost\");for(let[t,n]of Object.entries(r))n.adminKey=e[t];return r}async function G(r){let e=await Se(),[,t,n,o]=r.uri.split(\":\"),s=e[t];if(!s)throw new Error(\"No config for instance \"+t);let c=new x(s.url,s.adminKey);await c.init();let p=await d.readPage(r.name),f=await we(p);return f.slug=o,n===\"post\"?await c.publishPost(f):n===\"page\"&&await c.publishPage(f),!0}var Te=G;return V(be);})();\n return mod;})()"
    }
  },
  "assets": {}
}