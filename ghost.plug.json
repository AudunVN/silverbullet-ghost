{
  "name": "ghost",
  "imports": [
    "https://get.silverbullet.md/global.plug.json"
  ],
  "functions": {
    "publish": {
      "env": "server",
      "events": [
        "share:ghost"
      ],
      "code": "(() => { var mod=(()=>{var T=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var G=Object.prototype.hasOwnProperty;var y=(r,e)=>{for(var t in e)T(r,t,{get:e[t],enumerable:!0})},J=(r,e,t,n)=>{if(e&&typeof e==\"object\"||typeof e==\"function\")for(let i of L(e))!G.call(r,i)&&i!==t&&T(r,i,{get:()=>e[i],enumerable:!(n=B(e,i))||n.enumerable});return r};var Y=r=>J(T({},\"__esModule\",{value:!0}),r);var ve={};y(ve,{default:()=>Se});function S(r,e){if(e(r))return[r];let t=[];if(r.children)for(let n of r.children)t=[...t,...S(n,e)];return t}function v(r,e){if(r.children){let t=r.children.slice();for(let n of t){let i=e(n);if(i!==void 0){let s=r.children.indexOf(n);i?r.children.splice(s,1,i):r.children.splice(s,1)}else v(n,e)}}}function m(r,e){return S(r,t=>t.type===e)[0]}function N(r,e){S(r,e)}function A(r){let e=[];if(r.text!==void 0)return r.text;for(let t of r.children)e.push(A(t));return e.join(\"\")}typeof self>\"u\"&&(self={syscall:()=>{throw new Error(\"Not implemented here\")}});var o=self.syscall;var f={};y(f,{parseMarkdown:()=>z});function z(r){return o(\"markdown.parseMarkdown\",r)}var C=class{listPages(e=!1){return o(\"space.listPages\",e)}getPageMeta(e){return o(\"space.getPageMeta\",e)}readPage(e){return o(\"space.readPage\",e)}writePage(e,t){return o(\"space.writePage\",e,t)}deletePage(e){return o(\"space.deletePage\",e)}listPlugs(){return o(\"space.listPlugs\")}listAttachments(){return o(\"space.listAttachments\")}getAttachmentMeta(e){return o(\"space.getAttachmentMeta\",e)}readAttachment(e){return o(\"space.readAttachment\",e)}writeAttachment(e,t,n){return o(\"space.writeAttachment\",e,t,n)}deleteAttachment(e){return o(\"space.deleteAttachment\",e)}readFile(e,t){return o(\"space.readFile\",e,t)}getFileMeta(e){return o(\"space.getFileMeta\",e)}writeFile(e,t,n){return o(\"space.writeFile\",e,t,n)}deleteFile(e){return o(\"space.deleteFile\",e)}listFiles(e){return o(\"space.listFiles\",e)}},d=new C;var a=self.syscall;var g={};y(g,{parse:()=>ne,stringify:()=>ie});function ne(r){return a(\"yaml.parse\",r)}function ie(r){return a(\"yaml.stringify\",r)}async function oe(r,e){let t=await d.readPage(r),n=await f.parseMarkdown(t),i;return N(n,s=>{if(s.type!==\"FencedCode\")return!1;let u=m(s,\"CodeInfo\");if(e&&!u||e&&!e.includes(u.children[0].text))return!1;let h=m(s,\"CodeText\");return h?(i=h.children[0].text,!0):!1}),i}async function P(r,e=[\"yaml\"]){let t=await oe(r,e);if(t!==void 0)try{return g.parse(t)}catch(n){throw console.error(\"YAML Page parser error\",n),new Error(`YAML Error: ${n.message}`)}}var se=\"SETTINGS\";async function $(r,e){try{let n=(await P(se,[\"yaml\"])||{})[r];return n===void 0?e:n}catch(t){if(t.message===\"Not found\")return e;throw t}}async function F(r){try{let t=(await P(\"SECRETS\",[\"yaml\",\"secrets\"]))[r];if(t===void 0)throw new Error(`No such secret: ${r}`);return t}catch(e){throw e.message===\"Not found\"?new Error(`No such secret: ${r}`):e}}function ae(r){return r.replaceAll(\" \",\"_\")}async function O(r,e){let t=await f.parseMarkdown(r);return v(t,n=>{if(n.type===\"WikiLink\"){let i=n.children[1].children[0].text;return e&&!e.includes(i)?{text:`_${i}_`}:{text:`[${i}](/${ae(i)})`}}if(n.type===\"CommentBlock\"||n.type===\"Comment\"||n.type===\"NamedAnchor\")return null;if(n.type===\"Hashtag\")return{text:`__${n.children[0].text}__`};if(n.type===\"URL\"){let i=n.children[0].text;i.indexOf(\"://\")===-1&&(n.children[0].text=`fs/${i}`),console.log(\"Link\",i)}if(n.type===\"FencedCode\"){let i=m(n,\"CodeInfo\");if(!i)return;if(i.children[0].text===\"meta\")return null}}),A(t)}var c={};y(c,{decode:()=>me,encode:()=>de});var l=[\"A\",\"B\",\"C\",\"D\",\"E\",\"F\",\"G\",\"H\",\"I\",\"J\",\"K\",\"L\",\"M\",\"N\",\"O\",\"P\",\"Q\",\"R\",\"S\",\"T\",\"U\",\"V\",\"W\",\"X\",\"Y\",\"Z\",\"a\",\"b\",\"c\",\"d\",\"e\",\"f\",\"g\",\"h\",\"i\",\"j\",\"k\",\"l\",\"m\",\"n\",\"o\",\"p\",\"q\",\"r\",\"s\",\"t\",\"u\",\"v\",\"w\",\"x\",\"y\",\"z\",\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"+\",\"/\"];function R(r){let e=typeof r==\"string\"?new TextEncoder().encode(r):r instanceof Uint8Array?r:new Uint8Array(r),t=\"\",n,i=e.length;for(n=2;n<i;n+=3)t+=l[e[n-2]>>2],t+=l[(e[n-2]&3)<<4|e[n-1]>>4],t+=l[(e[n-1]&15)<<2|e[n]>>6],t+=l[e[n]&63];return n===i+1&&(t+=l[e[n-2]>>2],t+=l[(e[n-2]&3)<<4],t+=\"==\"),n===i&&(t+=l[e[n-2]>>2],t+=l[(e[n-2]&3)<<4|e[n-1]>>4],t+=l[(e[n-1]&15)<<2],t+=\"=\"),t}function D(r){let e=atob(r),t=e.length,n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return n}function ue(r){if(r.length%4===2)return r+\"==\";if(r.length%4===3)return r+\"=\";if(r.length%4===1)throw new TypeError(\"Illegal base64url string!\");return r}function ce(r){if(!/^[-_A-Z0-9]*?={0,2}$/i.test(r))throw new TypeError(\"Failed to decode base64url: invalid character\");return ue(r).replace(/\\-/g,\"+\").replace(/_/g,\"/\")}function fe(r){return r.replace(/=/g,\"\").replace(/\\+/g,\"-\").replace(/\\//g,\"_\")}function de(r){return fe(R(r))}function me(r){return D(ce(r))}var p=new TextEncoder,ge=new TextDecoder;function U(r){return r!==null}function H(r){return r===null}function x(r){return typeof r==\"string\"}function pe(r){return x(r.hash?.name)}function he(r){return x(r.namedCurve)}function j(r,e){if(r===\"none\"){if(U(e))throw new Error(`The alg '${r}' does not allow a key.`);return!0}else{if(!e)throw new Error(`The alg '${r}' demands a key.`);let t=e.algorithm,n=k(r);if(t.name===n.name){if(pe(t))return t.hash.name===n.hash.name;if(he(t))return t.namedCurve===n.namedCurve}return!1}}function k(r){switch(r){case\"HS256\":return{hash:{name:\"SHA-256\"},name:\"HMAC\"};case\"HS384\":return{hash:{name:\"SHA-384\"},name:\"HMAC\"};case\"HS512\":return{hash:{name:\"SHA-512\"},name:\"HMAC\"};case\"PS256\":return{hash:{name:\"SHA-256\"},name:\"RSA-PSS\",saltLength:32};case\"PS384\":return{hash:{name:\"SHA-384\"},name:\"RSA-PSS\",saltLength:48};case\"PS512\":return{hash:{name:\"SHA-512\"},name:\"RSA-PSS\",saltLength:64};case\"RS256\":return{hash:{name:\"SHA-256\"},name:\"RSASSA-PKCS1-v1_5\"};case\"RS384\":return{hash:{name:\"SHA-384\"},name:\"RSASSA-PKCS1-v1_5\"};case\"RS512\":return{hash:{name:\"SHA-512\"},name:\"RSASSA-PKCS1-v1_5\"};case\"ES256\":return{hash:{name:\"SHA-256\"},name:\"ECDSA\",namedCurve:\"P-256\"};case\"ES384\":return{hash:{name:\"SHA-384\"},name:\"ECDSA\",namedCurve:\"P-384\"};default:throw new Error(`The jwt's alg '${r}' is not supported.`)}}async function K(r,e,t){return H(e)?\"\":c.encode(new Uint8Array(await crypto.subtle.sign(k(r),e,p.encode(t))))}function ye(r,e){return`${c.encode(p.encode(JSON.stringify(r)))}.${c.encode(p.encode(JSON.stringify(e)))}`}async function _(r,e,t){if(j(r.alg,t)){let n=ye(r,e),i=await K(r.alg,t,n);return`${n}.${i}`}else throw new Error(`The jwt's alg '${r.alg}' does not match the key's algorithm.`)}function E(r){return Math.round((r instanceof Date?r.getTime():Date.now()+r*1e3)/1e3)}var Pe=r=>Uint8Array.from(r.match(/.{1,2}/g).map(e=>parseInt(e,16))),w=class{constructor(e,t){this.url=e;this.key=t}async init(){let[e,t]=this.key.split(\":\"),n=await crypto.subtle.importKey(\"raw\",Pe(t),{name:\"HMAC\",hash:\"SHA-256\"},!0,[\"sign\",\"verify\"]);this.token=await _({alg:\"HS256\",kid:e,typ:\"JWT\"},{exp:E(5*60),iat:E(0),aud:\"/v3/admin/\"},n)}async listPosts(){return(await(await fetch(`${this.url}/ghost/api/v3/admin/posts?order=published_at+DESC`,{headers:{Authorization:`Ghost ${this.token}`}})).json()).posts}async listMarkdownPosts(){let e=[];for(let t of await this.listPosts()){let n=JSON.parse(t.mobiledoc);n.cards.length>0&&n.cards[0][0]===\"markdown\"&&e.push(t)}return e}publishPost(e){return this.publish(\"posts\",e)}publishPage(e){return this.publish(\"pages\",e)}async publish(e,t){let i=await(await fetch(`${this.url}/ghost/api/v3/admin/${e}/slug/${t.slug}`,{headers:{Authorization:`Ghost ${this.token}`,\"Content-Type\":\"application/json\"}})).json();if(i[e]){let s=i[e][0];return t.updated_at=s.updated_at,(await(await fetch(`${this.url}/ghost/api/v3/admin/${e}/${s.id}`,{method:\"PUT\",headers:{Authorization:`Ghost ${this.token}`,\"Content-Type\":\"application/json\"},body:JSON.stringify({[e]:[t]})})).json())[e][0]}else return t.status||(t.status=\"draft\"),(await(await fetch(`${this.url}/ghost/api/v3/admin/${e}`,{method:\"POST\",headers:{Authorization:`Ghost ${this.token}`,\"Content-Type\":\"application/json\"},body:JSON.stringify({[e]:[t]})})).json())[e][0]}};function xe(r){return JSON.stringify({version:\"0.3.1\",atoms:[],cards:[[\"markdown\",{markdown:r}]],markups:[],sections:[[10,0],[1,\"p\",[]]]})}var we=/#\\s*([^\\n]+)\\n(([^\\n]|\\n)+)$/;async function be(r){let e=we.exec(r);if(e){let[,t,n]=e;return{title:t,mobiledoc:xe(await O(n))}}throw Error(\"Post should stat with a # header\")}async function Te(){let r=await $(\"ghost\"),e=await F(\"ghost\");for(let[t,n]of Object.entries(r))n.adminKey=e[t];return r}async function I(r){let e=await Te(),[,t,n,i]=r.uri.split(\":\"),s=e[t];if(!s)throw new Error(\"No config for instance \"+t);let u=new w(s.url,s.adminKey);await u.init();let h=await d.readPage(r.name),b=await be(h);return b.slug=i,n===\"post\"?await u.publishPost(b):n===\"page\"&&await u.publishPage(b),!0}var Se=I;return Y(ve);})();\n return mod;})()"
    }
  },
  "assets": {}
}