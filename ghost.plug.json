{
  "name": "ghost",
  "functions": {
    "publishCommand": {
      "command": {
        "name": "Ghost: Publish"
      },
      "code": "(() => { var mod=(()=>{var N=Object.create;var a=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var j=(e=>typeof require!=\"undefined\"?require:typeof Proxy!=\"undefined\"?new Proxy(e,{get:(r,t)=>(typeof require!=\"undefined\"?require:r)[t]}):e)(function(e){if(typeof require!=\"undefined\")return require.apply(this,arguments);throw new Error('Dynamic require of \"'+e+'\" is not supported')});var E=(e,r)=>{for(var t in r)a(e,t,{get:r[t],enumerable:!0})},P=(e,r,t,o)=>{if(r&&typeof r==\"object\"||typeof r==\"function\")for(let i of $(r))!A.call(e,i)&&i!==t&&a(e,i,{get:()=>r[i],enumerable:!(o=S(r,i))||o.enumerable});return e};var R=(e,r,t)=>(t=e!=null?N(O(e)):{},P(r||!e||!e.__esModule?a(t,\"default\",{value:e,enumerable:!0}):t,e)),B=e=>P(a({},\"__esModule\",{value:!0}),e);var L={};E(L,{default:()=>G});function c(e,r){if(r(e))return[e];let t=[];if(e.children)for(let o of e.children)t=[...t,...c(o,r)];return t}function l(e,r){return c(e,t=>t.type===r)[0]}function h(e,r){c(e,r)}typeof self>\"u\"&&(self={syscall:(e,...r)=>{throw new Error(\"Not implemented here\")}});var n=self.syscall;async function f(e){return n(\"markdown.parseMarkdown\",e)}async function x(e){return n(\"space.readPage\",e)}var y=R(j(\"yaml\"));async function u(e,r=[\"yaml\"]){let{text:t}=await x(e),o=await f(t),i={};return h(o,d=>{if(d.type!==\"FencedCode\")return!1;let p=l(d,\"CodeInfo\");if(!p||!r.includes(p.children[0].text))return!1;let g=l(d,\"CodeText\");if(!g)return!1;let M=g.children[0].text;try{i=y.default.parse(M)}catch(m){throw console.error(\"YAML Page parser error\",m),new Error(`YAML Error: ${m.message}`)}return!0}),i}async function w(e){try{let r=await u(\"SETTINGS\",[\"yaml\"])||{},t={};for(let[o,i]of Object.entries(e))r[o]?t[o]=r[o]:t[o]=i;return t}catch(r){if(r.message===\"Page not found\")return e;throw r}}async function T(e){try{let r=await u(\"SECRETS\",[\"yaml\",\"secrets\"]),t=[];for(let o of e){let i=r[o];if(i)t.push(i);else throw new Error(`No such secret: ${o}`)}return t}catch(r){throw r.message===\"Page not found\"?new Error(`No such secret: ${e[0]}`):r}}async function b(e,r,...t){return n(\"system.invokeFunction\",e,r,...t)}function v(){return n(\"editor.getCurrentPage\")}function k(){return n(\"editor.getText\")}function s(e,r=\"info\"){return n(\"editor.flashNotification\",e,r)}async function D(){let{ghostUrl:e,ghostPostPrefix:r,ghostPagePrefix:t}=await w({ghostUrl:\"\",ghostPostPrefix:\"ghost/post\",ghostPagePrefix:\"ghost/page\"}),[o]=await T([\"ghostAdminKey\"]);return{url:e,pagePrefix:t,postPrefix:r,adminKey:o}}async function C(){let e=await D(),r=await v();if(r.startsWith(e.pagePrefix))await s(\"Publishing page to Ghost...\");else if(r.startsWith(e.postPrefix))await s(\"Publishing post to Ghost...\");else{await s(\"Page is not in either the page or post prefix\",\"error\");return}await b(\"server\",\"publish\",r,await k())?await s(\"Publish successful!\"):await s(\"Publish failed!\")}var G=C;return B(L);})();\n return mod;})()"
    },
    "publish": {
      "env": "server",
      "code": "(() => { var mod=(()=>{var N=Object.create;var l=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var j=(r=>typeof require!=\"undefined\"?require:typeof Proxy!=\"undefined\"?new Proxy(r,{get:(e,t)=>(typeof require!=\"undefined\"?require:e)[t]}):r)(function(r){if(typeof require!=\"undefined\")return require.apply(this,arguments);throw new Error('Dynamic require of \"'+r+'\" is not supported')});var E=(r,e)=>{for(var t in e)l(r,t,{get:e[t],enumerable:!0})},x=(r,e,t,o)=>{if(e&&typeof e==\"object\"||typeof e==\"function\")for(let i of $(e))!A.call(r,i)&&i!==t&&l(r,i,{get:()=>e[i],enumerable:!(o=S(e,i))||o.enumerable});return r};var R=(r,e,t)=>(t=r!=null?N(O(r)):{},x(e||!r||!r.__esModule?l(t,\"default\",{value:r,enumerable:!0}):t,r)),B=r=>x(l({},\"__esModule\",{value:!0}),r);var Y={};E(Y,{default:()=>U});function p(r,e){if(e(r))return[r];let t=[];if(r.children)for(let o of r.children)t=[...t,...p(o,e)];return t}function g(r,e){if(r.children){let t=r.children.slice();for(let o of t){let i=e(o);if(i!==void 0){let n=r.children.indexOf(o);i?r.children.splice(n,1,i):r.children.splice(n,1)}else g(o,e)}}}function a(r,e){return p(r,t=>t.type===e)[0]}function y(r,e){p(r,e)}function m(r){let e=[];if(r.text!==void 0)return r.text;for(let t of r.children)e.push(m(t));return e.join(\"\")}typeof self>\"u\"&&(self={syscall:(r,...e)=>{throw new Error(\"Not implemented here\")}});var s=self.syscall;async function u(r){return s(\"markdown.parseMarkdown\",r)}async function w(r){return s(\"space.readPage\",r)}var T=R(j(\"yaml\"));async function d(r,e=[\"yaml\"]){let{text:t}=await w(r),o=await u(t),i={};return y(o,n=>{if(n.type!==\"FencedCode\")return!1;let f=a(n,\"CodeInfo\");if(!f||!e.includes(f.children[0].text))return!1;let P=a(n,\"CodeText\");if(!P)return!1;let M=P.children[0].text;try{i=T.default.parse(M)}catch(h){throw console.error(\"YAML Page parser error\",h),new Error(`YAML Error: ${h.message}`)}return!0}),i}async function b(r){try{let e=await d(\"SETTINGS\",[\"yaml\"])||{},t={};for(let[o,i]of Object.entries(r))e[o]?t[o]=e[o]:t[o]=i;return t}catch(e){if(e.message===\"Page not found\")return r;throw e}}async function v(r){try{let e=await d(\"SECRETS\",[\"yaml\",\"secrets\"]),t=[];for(let o of r){let i=e[o];if(i)t.push(i);else throw new Error(`No such secret: ${o}`)}return t}catch(e){throw e.message===\"Page not found\"?new Error(`No such secret: ${r[0]}`):e}}function D(r){return r.replaceAll(\" \",\"_\")}async function k(r){let e=await u(r);return g(e,t=>{if(t.type===\"WikiLink\"){let o=t.children[1].children[0].text;return{text:`[${o}](/${D(o)})`}}if(t.type===\"CommentBlock\"||t.type===\"Comment\")return null;if(t.type===\"FencedCode\"){let o=a(t,\"CodeInfo\");if(!o)return;if(o.children[0].text===\"meta\")return null}}),m(e)}var c=class{constructor(e,t){this.url=e;this.key=t}async init(){let[e,t]=this.key.split(\":\");this.token=await self.syscall(\"jwt.jwt\",t,e,\"HS256\",\"5m\",\"/v3/admin/\")}async listPosts(){return(await(await fetch(`${this.url}/ghost/api/v3/admin/posts?order=published_at+DESC`,{headers:{Authorization:`Ghost ${this.token}`}})).json()).posts}async listMarkdownPosts(){let e=[];for(let t of await this.listPosts()){let o=JSON.parse(t.mobiledoc);o.cards.length>0&&o.cards[0][0]===\"markdown\"&&e.push(t)}return e}publishPost(e){return this.publish(\"posts\",e)}publishPage(e){return this.publish(\"pages\",e)}async publish(e,t){let i=await(await fetch(`${this.url}/ghost/api/v3/admin/${e}/slug/${t.slug}`,{headers:{Authorization:`Ghost ${this.token}`,\"Content-Type\":\"application/json\"}})).json();if(i[e]){let n=i[e][0];return t.updated_at=n.updated_at,(await(await fetch(`${this.url}/ghost/api/v3/admin/${e}/${n.id}`,{method:\"PUT\",headers:{Authorization:`Ghost ${this.token}`,\"Content-Type\":\"application/json\"},body:JSON.stringify({[e]:[t]})})).json())[e][0]}else return t.status||(t.status=\"draft\"),(await(await fetch(`${this.url}/ghost/api/v3/admin/${e}`,{method:\"POST\",headers:{Authorization:`Ghost ${this.token}`,\"Content-Type\":\"application/json\"},body:JSON.stringify({[e]:[t]})})).json())[e][0]}};function G(r){return JSON.stringify({version:\"0.3.1\",atoms:[],cards:[[\"markdown\",{markdown:r}]],markups:[],sections:[[10,0],[1,\"p\",[]]]})}var L=/#\\s*([^\\n]+)\\n([^$]+)$/;async function _(r){let e=L.exec(r);if(e){let[,t,o]=e;return{title:t,mobiledoc:G(await k(o))}}throw Error(\"Post should stat with a # header\")}async function F(){let{ghostUrl:r,ghostPostPrefix:e,ghostPagePrefix:t}=await b({ghostUrl:\"\",ghostPostPrefix:\"ghost/post\",ghostPagePrefix:\"ghost/page\"}),[o]=await v([\"ghostAdminKey\"]);return{url:r,pagePrefix:t,postPrefix:e,adminKey:o}}async function C(r,e){let t=await F(),o=new c(t.url,t.adminKey);await o.init();let i=await _(e);return r.startsWith(t.postPrefix)?(i.slug=r.substring(t.postPrefix.length+1),await o.publishPost(i),!0):r.startsWith(t.pagePrefix)?(i.slug=r.substring(t.pagePrefix.length+1),await o.publishPage(i),!0):!1}var U=C;return B(Y);})();\n return mod;})()"
    }
  }
}